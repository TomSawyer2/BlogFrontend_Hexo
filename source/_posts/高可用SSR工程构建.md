---
title: 高可用SSR工程构建
date: 2022-01-19 13:20:00
categories:
- SSR
- 学习笔记
tags:
- SSR
- 学习笔记
---

# 高可用 SSR 工程构建

## 简介

平时写写 Vue、React，build 之后往服务器上一丢，配下 nginx，网站就上线了。一般写的 Web 应用都是 SPA，即单页应用，这类应用相对传统的后端模板应用有优点：首次实现前后端分离、将 MVVM 中的渲染层完全交给前端，后端只需要负责接口、服务以及数据层相关操作即可。但是这类应用同时也有缺点：不利于 SEO、首屏渲染慢等等。对于 SEO 优化，Vue 有比较成熟的配套解决方案；对于首屏加载慢这个问题，Webpack 也提供了一些方案，比如组件懒加载、组件按需引入、tree shake、chunk 拆分优化等等。但是一波操作下来，SPA 应用的首屏加载速度仍是个问题，本站的首屏即存在这一问题。因此，可以考虑使用 SSR 应用来优化首屏的加载，此外，SSR 完全支持降级，可以把渲染工作交回客户端。

## 实现

SSR 应用即将渲染这一功能放在了服务端，直接将渲染完的内容传回前端即客户端展示即可。在服务端进行 js 代码的渲染需要注意几个问题：运行环境不在浏览器，生命周期中不能用 DOM 和 BOM 对象；需要多 app.js，Server entry，Client entry 分别用于暴露 createApp()方法、打包成 json 文件、打包成 json 文件。服务端根据打包后的 json，调用 createBundleRenderer 生成 renderer 实例，再通过调用 renderer.renderToString 生成 html 字符串，最后返回给浏览器，同时需要根据 json 生成的 js 配合 html 字符串 hydrate 完成客户端 html 的激活。

## 优化

1. 和传统 SPA 应用一样，拆分代码，这里主要指把 main.js 拆分成单独的路由组件和 js 文件；
2. 不需要 SSR 的模块进行客户端渲染，由于服务端渲染是 CPU 密集型操作，所以一些不需要 SSR 的模块可以交给客户端，同时响应更快；
3. 页面/组件缓存；
4. 页面静态化，直接放 CDN。

## 降级

1. 单流量降级：单个 SSR 失败就交回客户端渲染；
2. Disconf/Apollo 配置降级：分布式配置平台修改配置主动降级交给客户端，比如双十一之前就可以配置降级；
3. CPU 阈值降级：CPU 占用过高时交回客户端渲染；
4. 旁路系统降级：集群资源达到阈值时降级或者自动扩容；
5. 渲染服务集群降级：渲染服务集群炸了的时候 html 获取逻辑返回 nginx，使用客户端渲染，并用 xhr 进行接口获取。

## SPA 与 SSR 实现同构

Web 应用在首屏加载时使用 SSR，之后使用 SPA，即实现了应用的同构，这样的应用使用体验更好。
